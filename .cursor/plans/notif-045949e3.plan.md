<!-- 045949e3-4260-4d3a-afd3-1470c8fb1057 2c4884f9-a3dc-4324-81f9-49b09e73d776 -->
# Notification System Feature

## Overview

Implement a real-time notification system that:

1. Creates a special "Notifications" conversation for each user (system-generated)
2. Prevents users from sending messages to this conversation (read-only)
3. Sends notifications when admins update support tickets
4. Auto-deletes notifications after 7 days
5. Supports multiple notification types (extensible for future use)

## Architecture

### Database Schema Changes

- Add `notifications` table to store notification records with TTL metadata
- Modify `conversations` table to include `isSystemNotification` flag for special handling
- Add notification type tracking for extensibility

### Backend Implementation (Convex)

#### 1. Schema Updates (`convex/schema.ts`)

- Add `notifications` table with fields:
- `userId`: recipient ID
- `type`: "ticket_update" | "future_types"
- `ticketId`: reference to support ticket
- `action`: "replied" | "opened" | "closed" | "status_changed" | "messaged"
- `message`: description of what happened
- `ticketLink`: URL or ID reference to ticket
- `createdAt`: timestamp
- `expiresAt`: deletion timestamp (7 days from creation)
- Proper indexes: `by_user_created`, `by_expires_at`, `by_user_type`

#### 2. Notification Conversation Setup (`convex/notifications.ts` - new file)

- `ensureNotificationConversation()` - creates "Notifications" conversation for user on first access
- `sendNotification()` - creates a notification message in the user's Notifications conversation
- Internal mutation to create system notification messages
- Query to fetch notification conversation for current user

#### 3. Support Ticket Integration (`convex/supportTickets.ts`)

- Modify `addSupportTicketUpdate()` - send notification to ticket creator
- Modify `updateSupportTicketStatus()` - send notification with action details
- Create helper to determine notification action type and message

#### 4. Cleanup (`convex/crons.ts`)

- Add cron job to delete expired notifications every 6 hours

### Frontend Implementation

#### 1. UI Components

- Create notification icon avatar component
- Modify conversation view to handle read-only conversations
- Add notification message rendering (without send input)
- Display ticket links/metadata in notifications

#### 2. Integration Points

- Modify `ConversationView` to detect system notifications and disable input
- Add visual indicator for notification messages
- Show ticket references and action descriptions

## Implementation Todos

### Backend

- [ ] schema-add-notifications: Add notifications table and modify conversations table
- [ ] notifications-file-create: Create convex/notifications.ts with core functions
- [ ] support-tickets-integrate: Modify support ticket mutations to trigger notifications
- [ ] cron-cleanup: Add notification expiration cleanup job
- [ ] verify-convex: Run convex dev to verify no errors

### Frontend

- [ ] avatar-component: Create NotificationIcon avatar component
- [ ] conversation-view-modify: Update ConversationView to handle read-only mode
- [ ] message-rendering: Ensure notifications display with ticket info
- [ ] ui-testing: Test notification display and interaction

## Key Features

- Real-time notifications via existing messaging system
- Automatic cleanup after 7 days
- Extensible for future notification types
- Read-only conversation prevents accidental replies
- Integrates seamlessly with existing messaging UI
- Admin-triggered notifications from ticket updates

## Files to Create/Modify

- **Create**: `convex/notifications.ts`
- **Modify**: `convex/schema.ts`, `convex/supportTickets.ts`, `convex/crons.ts`
- **Create**: `src/components/NotificationIcon.tsx` (optional, uses emoji or icon)
- **Modify**: `src/components/messaging/ConversationView.tsx` (add read-only mode)

### To-dos

- [ ] Add notifications table to schema.ts with proper fields and indexes for user-based queries
- [ ] Add isSystemNotification flag to conversations table to identify system conversations
- [ ] Create convex/notifications.ts with ensureNotificationConversation, sendNotification, and helper functions
- [ ] Modify supportTickets.ts to send notifications on ticket updates (reply, status change, assignment)
- [ ] Run bunx convex dev --once to verify no compilation errors
- [ ] Modify ConversationView to detect read-only notifications and disable send input
- [ ] Ensure notification messages display ticket info (link, action, message) clearly
- [ ] Test notification display and ensure no UI regressions with existing messaging